---
// No server-side code needed
---

<div class="converter">
  <div class="header">
    <h1>Markdown to PDF</h1>
    <p>Convert your Markdown to professional PDFs instantly</p>
  </div>

  <div class="container">
    <div class="editor-panel">
      <div class="panel-header">
        <h2>Markdown Input</h2>
        <button id="clear-btn" class="btn-secondary">Clear</button>
      </div>
      <textarea
        id="markdown-input"
        placeholder="# Start typing your Markdown here...

## Features
- **Bold text**
- *Italic text*
- [Links](https://example.com)
- `Code`

### Tables
| Header 1 | Header 2 |
|----------|----------|
| Cell 1   | Cell 2   |

> Blockquotes work too!"
        spellcheck="false"
      ></textarea>
    </div>

    <div class="preview-panel">
      <div class="panel-header">
        <h2>Preview</h2>
        <div class="button-group">
          <button id="preview-btn" class="btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Preview
          </button>
          <button id="download-btn" class="btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download PDF
          </button>
        </div>
      </div>
      <div id="preview-output" class="preview-content"></div>
    </div>
  </div>

  <div id="status-message" class="status-message"></div>
</div>

<script>
  import { marked } from 'marked';
  import htmlToPdfmake from 'html-to-pdfmake';
  import pdfMake from 'pdfmake/build/pdfmake';
  import pdfFonts from 'pdfmake/build/vfs_fonts';

  // For pdfmake 0.2.15+, pdfFonts IS the vfs object
  pdfMake.vfs = pdfFonts;

  // Configure marked options
  marked.setOptions({
    breaks: true,
    gfm: true,
  });

  // DOM elements
  const markdownInput = document.getElementById('markdown-input') as HTMLTextAreaElement;
  const previewOutput = document.getElementById('preview-output') as HTMLDivElement;
  const previewBtn = document.getElementById('preview-btn') as HTMLButtonElement;
  const downloadBtn = document.getElementById('download-btn') as HTMLButtonElement;
  const clearBtn = document.getElementById('clear-btn') as HTMLButtonElement;
  const statusMessage = document.getElementById('status-message') as HTMLDivElement;

  // Show status message
  function showStatus(message: string, type: 'success' | 'error' | 'info') {
    statusMessage.textContent = message;
    statusMessage.className = `status-message ${type} visible`;
    setTimeout(() => {
      statusMessage.classList.remove('visible');
    }, 3000);
  }

  // Preview function
  function previewMarkdown() {
    try {
      const markdown = markdownInput.value;

      if (!markdown.trim()) {
        previewOutput.innerHTML = '<p class="empty-state">No content to preview. Start typing in the editor.</p>';
        return;
      }

      // Convert Markdown to HTML
      const html = marked.parse(markdown);

      // Display HTML preview
      previewOutput.innerHTML = html;

      showStatus('Preview updated', 'success');
    } catch (error) {
      console.error('Preview error:', error);
      showStatus('Error generating preview', 'error');
      previewOutput.innerHTML = `<p class="error-state">Error: ${error.message}</p>`;
    }
  }

  // Download PDF function
  function downloadPDF() {
    try {
      const markdown = markdownInput.value;

      if (!markdown.trim()) {
        showStatus('Please enter some Markdown text first', 'error');
        return;
      }

      showStatus('Generating PDF...', 'info');

      // Step 1: Markdown → HTML
      const html = marked.parse(markdown);

      // Step 2: HTML → pdfmake format
      const pdfContent = htmlToPdfmake(html, {
        window: window
      });

      // Step 3: Create PDF document definition
      const docDefinition = {
        content: pdfContent,
        defaultStyle: {
          fontSize: 11,
          font: 'Roboto'
        },
        // Add explicit encoding
        info: {
          title: 'Markdown Document',
          creator: 'MD2PDF',
        },
        styles: {
          'html-h1': {
            fontSize: 24,
            bold: true,
            margin: [0, 20, 0, 10] as [number, number, number, number]
          },
          'html-h2': {
            fontSize: 20,
            bold: true,
            margin: [0, 15, 0, 8] as [number, number, number, number]
          },
          'html-h3': {
            fontSize: 16,
            bold: true,
            margin: [0, 12, 0, 6] as [number, number, number, number]
          },
          'html-h4': {
            fontSize: 14,
            bold: true,
            margin: [0, 10, 0, 5] as [number, number, number, number]
          },
          'html-h5': {
            fontSize: 12,
            bold: true,
            margin: [0, 8, 0, 4] as [number, number, number, number]
          },
          'html-h6': {
            fontSize: 11,
            bold: true,
            margin: [0, 6, 0, 3] as [number, number, number, number]
          },
          'html-p': {
            margin: [0, 5, 0, 5] as [number, number, number, number]
          },
          'html-ul': {
            margin: [0, 5, 0, 5] as [number, number, number, number]
          },
          'html-ol': {
            margin: [0, 5, 0, 5] as [number, number, number, number]
          },
          'html-table': {
            margin: [0, 10, 0, 10] as [number, number, number, number]
          },
          'html-code': {
            fontSize: 10,
            background: '#f5f5f5'
          },
          'html-blockquote': {
            italics: true,
            margin: [10, 5, 10, 5] as [number, number, number, number],
            color: '#666666'
          }
        },
        pageMargins: [50, 50, 50, 50] as [number, number, number, number]
      };

      // Step 4: Generate and download PDF
      const timestamp = new Date().toISOString().slice(0, 10);
      const filename = `markdown-${timestamp}.pdf`;

      pdfMake.createPdf(docDefinition).download(filename);

      showStatus(`PDF downloaded: ${filename}`, 'success');
    } catch (error) {
      console.error('PDF generation error:', error);
      showStatus(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  // Clear function
  function clearInput() {
    if (confirm('Clear all content?')) {
      markdownInput.value = '';
      previewOutput.innerHTML = '<p class="empty-state">No content to preview. Start typing in the editor.</p>';
      showStatus('Content cleared', 'info');
    }
  }

  // Event listeners
  previewBtn.addEventListener('click', previewMarkdown);
  downloadBtn.addEventListener('click', downloadPDF);
  clearBtn.addEventListener('click', clearInput);

  // Auto-preview on Ctrl/Cmd + Enter
  markdownInput.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      previewMarkdown();
    }
  });

  // Load sample content on first visit
  if (!markdownInput.value.trim()) {
    markdownInput.value = markdownInput.placeholder;
    setTimeout(() => previewMarkdown(), 100);
  }
</script>

<style>
  .converter {
    min-height: 100vh;
    padding: 2rem;
  }

  .header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .header h1 {
    font-size: 3rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--color-accent), var(--color-success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }

  .header p {
    color: var(--color-text-dim);
    font-size: 1.125rem;
  }

  .container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-width: 1600px;
    margin: 0 auto;
  }

  @media (max-width: 1024px) {
    .container {
      grid-template-columns: 1fr;
    }
  }

  .editor-panel,
  .preview-panel {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 250px);
    min-height: 500px;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg);
  }

  .panel-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
  }

  .button-group {
    display: flex;
    gap: 0.5rem;
  }

  #markdown-input {
    flex: 1;
    width: 100%;
    padding: 1.5rem;
    background: var(--color-surface);
    color: var(--color-text);
    border: none;
    outline: none;
    font-family: var(--font-mono);
    font-size: 0.9375rem;
    line-height: 1.6;
    resize: none;
  }

  #markdown-input::placeholder {
    color: var(--color-text-dim);
  }

  .preview-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    background: var(--color-surface);
  }

  /* Preview content styling */
  .preview-content :global(h1),
  .preview-content :global(h2),
  .preview-content :global(h3),
  .preview-content :global(h4),
  .preview-content :global(h5),
  .preview-content :global(h6) {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
    line-height: 1.25;
  }

  .preview-content :global(h1) { font-size: 2rem; }
  .preview-content :global(h2) { font-size: 1.5rem; }
  .preview-content :global(h3) { font-size: 1.25rem; }

  .preview-content :global(p) {
    margin-bottom: 1rem;
  }

  .preview-content :global(a) {
    color: var(--color-accent);
    text-decoration: none;
  }

  .preview-content :global(a:hover) {
    text-decoration: underline;
  }

  .preview-content :global(ul),
  .preview-content :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }

  .preview-content :global(li) {
    margin-bottom: 0.25rem;
  }

  .preview-content :global(code) {
    background: var(--color-bg);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 0.875em;
  }

  .preview-content :global(pre) {
    background: var(--color-bg);
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    margin-bottom: 1rem;
  }

  .preview-content :global(pre code) {
    background: none;
    padding: 0;
  }

  .preview-content :global(blockquote) {
    border-left: 3px solid var(--color-accent);
    padding-left: 1rem;
    margin: 1rem 0;
    color: var(--color-text-dim);
    font-style: italic;
  }

  .preview-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  .preview-content :global(th),
  .preview-content :global(td) {
    border: 1px solid var(--color-border);
    padding: 0.5rem;
    text-align: left;
  }

  .preview-content :global(th) {
    background: var(--color-bg);
    font-weight: 600;
  }

  .empty-state,
  .error-state {
    color: var(--color-text-dim);
    text-align: center;
    padding: 3rem;
    font-style: italic;
  }

  .error-state {
    color: #ef4444;
  }

  /* Buttons */
  button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--color-accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: transparent;
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg);
    border-color: var(--color-accent);
  }

  button:active {
    transform: translateY(0);
  }

  /* Status message */
  .status-message {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s;
    pointer-events: none;
    z-index: 1000;
  }

  .status-message.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .status-message.success {
    border-color: var(--color-success);
    color: var(--color-success);
  }

  .status-message.error {
    border-color: #ef4444;
    color: #ef4444;
  }

  .status-message.info {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }
</style>

